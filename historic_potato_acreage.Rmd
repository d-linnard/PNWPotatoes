---
title: "Historic potato acreage WA"
author: "Hannah Tarlyn"
date: "9/19/2020"
output: html_document
---
### Load libraries
```{r}
library(rnassqs)
library(pkgmaker)
library(dplyr)
library(ggplot2)
library(data.table)
```
### Set API key
```{r}
nassqs_auth(key = 'E41D0CC0-8353-3153-A16A-850F2F13AC0E')
```

### Define search parameters
```{r}
nassqs_params()
```
#### Parameters to query on the data call
#### Gather potato data for year 1950 in Washington
```{r}
params <- list(commodity_desc = "potatoes", year = 1950, state_alpha = "WA")

nassqs(params)
```
# Acreage
```{r}
nassqs_acres(params)
```
### Collect data from multiple years
#### Define the list of parameters to use repeatedly
```{r}
param_list <- list(commodity_desc = "potatoes", state_alpha = "WA")
```
### Acreage, iterate through each year to get data
```{r}
data_list <- lapply(1885:2019, function(yr) {
  params <- param_list
  params[['year']] <- yr
  nassqs_acres(params)
})
```
#### Using dplyr to bind the data list
```{r}
dta <- rbindlist(data_list, use.names = TRUE)
```
### Inspect data structure and features
#### Check that our record request is under the 50,000 limit
```{r}
dim(dta)
table(dta$year)
str(dta)
```
### Summary statistics
```{r}
class(dta$Value)
dta$Value
```
### Coerce value into a number
```{r}
dta$value = as.numeric(gsub(",", "", dta$Value))
dta$value
summary(as.numeric(dta$value))
lapply(dta, unique)
```
### Plot
#### Set plot size
```{r}
options(repr.plot.width = 20, repr.plot.height = 10)
```
#### Create plot
```{r}
dta %>%
  group_by(year) %>%
  select(year, value, county_name) %>%
  ggplot(aes(x=year, y=value)) +
  geom_jitter(aes(colour = county_name), size=5, alpha=3/5) +
  theme_classic() +
  theme(axis.title.x=element_text(size=16, face="bold"),
        axis.text.x=element_text(size=14),
        axis.title.y=element_text(size=16,face="bold"),
        axis.text.y=element_text(size=14)) +
  scale_color_hue(l=70, c=40) +
  labs(x="Time (1885-2019)",
       y="Acres") +
  geom_smooth(method = "loess", span = 0.1, se = FALSE, color="grey40")
```

## Map Data
### Install and load packages
```{r}
library("rnaturalearth")
library("rnaturalearthdata")
library("ggplot2")
library("rworldmap")
library(dplyr)
library(geosphere)
library(gpclib)
library(tidyverse)
library(mapdata)
library(raster)
library(geojsonio)
library(usmap)
```
## World Map
#### Map of US with several states outlined as a trial/practice map
```{r}
worldMap <- getMap()
world.points <- fortify(worldMap)
world.points$region <- world.points$id
states <- map_data("state")
states = states %>%
  filter(region %in% c("montana", "california","washington","pennsylvania"))#

world.df <- world.points[,c("long","lat","group", "region")]

p = worldmap <- ggplot() + 
  geom_polygon(data = world.df, aes(x = long, y = lat, group = group),
               color="grey", fill="grey") +
  geom_polygon(data = states, aes(x = long, y = lat, group = group),
               color="black", fill="grey", lwd=0.35) +
  scale_y_continuous(breaks = (-2:2) * 30) +
  scale_x_continuous(breaks = (-4:4) * 45) +
  coord_map("ortho", orientation=c(40, -90, 0))

p

setwd('/Users/Hannah 23/Documents')
# Saving the map as a tiff file
tiff('PA.tiff', units="in", 
     width=5, height=5,
     res=600, compression = 'lzw')
p
dev.off()
```

## PNW
### Obtain data, states and provinces in and around PNW
```{r}
us <- getData("GADM",country="USA",level=1)
canada <- getData("GADM",country="CAN",level=1)
states <- c('Idaho', 'Oregon', 'Washington', 'Montana', 'California', 'Nevada', 'Utah', 'Wyoming')
provinces <- c("British Columbia", "Alberta")
```
### Subset data into US states and Canadian provinces
```{r}
us.states <- us[us$NAME_1 %in% states,]
ca.provinces  <- canada[canada$NAME_1 %in% provinces,]
```
### Plot of PNW with states of interest outlined in black and surrounding states in grey
```{r}
p <- ggplot(us.states,
       aes(x=long, y=lat, group=group))+
  geom_path(size=0.25)+
  geom_path(data=ca.provinces, size=0.25,color="grey60")+
  geom_path(data=subset(us.states, NAME_1 %in% c('Montana', 'California','Nevada','Utah','Wyoming')),
            size=0.25,color="grey60")+
  geom_polygon(data=subset(us.states, NAME_1 %in% c('Idaho', 'Oregon', 'Washington')),
               aes(x=long, y=lat, group=group), fill="white", colour = "black", size=0.50)+
  theme(panel.background = element_rect(fill = "white", colour = "grey50"))+
  coord_map("bonne", lat0 = 50,
            xlim = c(-127, -112),ylim = c(41, 50))+
  xlab("Longitude") +
  ylab("Latitude")
  
```

```{r}
setwd('/Users/Hannah 23/Documents')

```
#### Changing plot size and saving as a tiff file
```{r}
tiff('PNW-s.tiff', units="in", 
     width=10, height=10,
     res=300, compression = 'lzw')
options(repr.plot.width=20, repr.plot.height=20)
p
dev.off()
```

## Washington counties mapping

### Load packages
```{r, message=F, echo=F}
# Packages for graphics
library(ggplot2)
library(gridExtra)
library(ggExtra)
library(naniar) # To visualize missing data
library(Hmisc) # To tabulate a summary of the data
library(maps) # for maps
library(knitr) # format tables
library(ggplot2) # For diagnostics
# Packages for data wrangling
library(dplyr)
library(tidyr)
library(reshape2)
# Packages for inference /presentation of inference*
library(stargazer)
library(plm) # For estimating fixed and random effect model
library(lmtest)
library(sandwich) # for robust standard errors
library(knitr)
opts_chunk$set(tidy.opts=list(width.cutoff=60),tidy=TRUE)
```
### Load historic potato acreage data
```{r}
data_list #Load in acreage
#Rename dataframe
df <- data_list
```
### Summary of dataframe
```{r}
#Checking structure 
str(df)
#Summary of dataframe
summary("df")

```
### Check for missing values
```{r}
is.na(x)
```
### Open map data
```{r}
MainStates <- map_data("state")
```
### Add new columns for potato acerage over time
```{r}
Statesdf <- df %>%
  dplyr::select(acerage, state, year, county) %>%
  mutate("region" = rep(unique(MainStates$region)[-8],
                        each=25))
```
### WA county map
```{r}
plot_usmap(regions = "counties", include = c("WA"))
```

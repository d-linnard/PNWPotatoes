---
title: "Historic potato acreage WA"
author: "Hannah Tarlyn"
date: "9/19/2020"
output: html_document
R version: R-4.0.2
---
### Load libraries
```{r}
library(rnassqs)
library(pkgmaker)
library(dplyr)
library(ggplot2)
library(data.table)
```
### Set API key
```{r}
nassqs_auth(key = 'E41D0CC0-8353-3153-A16A-850F2F13AC0E')
```

### Define search parameters
```{r setup, include=FALSE}
nassqs_params()
```
#### Parameters to query on the data call
#### Sanity check: Gather potato data for year 1950 in Washington
```{r}
params <- list(commodity_desc = "potatoes", year = 1950, state_alpha = "WA")

nassqs(params)
```
# Acreage
```{r}
nassqs_acres(params)
```
### Collect data from multiple years
#### Define the list of parameters to use repeatedly
```{r}
param_list <- list(commodity_desc = "potatoes", state_alpha = "WA")
```
### Acreage, iterate through each year to get data
```{r}
data_list <- lapply(1882:2019, function(yr) {
  params <- param_list
  params[['year']] <- yr
  nassqs_acres(params)
})
```
#### Using dplyr to bind the data list
```{r}
dta <- rbindlist(data_list, use.names = TRUE)
```
### Inspect data structure and features
#### Check that our record request is under the 50,000 limit
```{r setup, include=FALSE}
dim(dta)
table(dta$year)
str(dta)
```
### Summary statistics
```{r setup, include=FALSE}
class(dta$Value)
dta$Value
```
### Coerce value into a number
```{r setup, include=FALSE, warning=F}
dta$value = as.numeric(gsub(",", "", dta$Value))
dta$value
summary(as.numeric(dta$value))
lapply(dta, unique)
```
### Plot
#### Set plot size
```{r}
options(repr.plot.width = 20, repr.plot.height = 10)
```
#### Create plot
```{r}
dta %>%
  group_by(year) %>%
  select(year, value, county_name) %>%
  ggplot(aes(x=year, y=value)) +
  geom_jitter(aes(colour = county_name), size=5, alpha=3/5) +
  theme_classic() +
  theme(axis.title.x=element_text(size=16, face="bold"),
        axis.text.x=element_text(size=14),
        axis.title.y=element_text(size=16,face="bold"),
        axis.text.y=element_text(size=14)) +
  scale_color_hue(l=70, c=40) +
  labs(x="Time (1882-2019)",
       y="Acres") +
  geom_smooth(method = "loess", span = 0.1, se = FALSE, color="grey40")
```
## Map Data
### Install and load packages
```{r}
library("rnaturalearth")
library("rnaturalearthdata")
library("ggplot2")
library("rworldmap")
library(dplyr)
library(geosphere)
library(gpclib)
library(tidyverse)
library(mapdata)
library(raster)
library(geojsonio)
library(usmap)
```
## World Map
#### Map of US with several states outlined as a trial/practice map
```{r}
worldMap <- getMap()
world.points <- fortify(worldMap)
world.points$region <- world.points$id
states <- map_data("state")
states = states %>%
  filter(region %in% c("montana", "california","washington","pennsylvania"))#

world.df <- world.points[,c("long","lat","group", "region")]

p = worldmap <- ggplot() + 
  geom_polygon(data = world.df, aes(x = long, y = lat, group = group),
               color="grey", fill="grey") +
  geom_polygon(data = states, aes(x = long, y = lat, group = group),
               color="black", fill="grey", lwd=0.35) +
  scale_y_continuous(breaks = (-2:2) * 30) +
  scale_x_continuous(breaks = (-4:4) * 45) +
  coord_map("ortho", orientation=c(40, -90, 0))

p

##setwd('/Users/Hannah 23/Documents')
# Saving the map as a tiff file
tiff('PA.tiff', units="in", 
     width=5, height=5,
     res=600, compression = 'lzw')
p
dev.off()
```

## PNW
### Obtain data, states and provinces in and around PNW
```{r}
us <- getData("GADM",country="USA",level=1)
canada <- getData("GADM",country="CAN",level=1)
states <- c('Idaho', 'Oregon', 'Washington', 'Montana', 'California', 'Nevada', 'Utah', 'Wyoming')
provinces <- c("British Columbia", "Alberta")
```
### Subset data into US states and Canadian provinces
```{r}
us.states <- us[us$NAME_1 %in% states,]
ca.provinces  <- canada[canada$NAME_1 %in% provinces,]
```
### Plot of PNW with states of interest outlined in black and surrounding states in grey
```{r}
p <- ggplot(us.states,
       aes(x=long, y=lat, group=group))+
  geom_path(size=0.25)+
  geom_path(data=ca.provinces, size=0.25,color="grey60")+
  geom_path(data=subset(us.states, NAME_1 %in% c('Montana', 'California','Nevada','Utah','Wyoming')),
            size=0.25,color="grey60")+
  geom_polygon(data=subset(us.states, NAME_1 %in% c('Idaho', 'Oregon', 'Washington')),
               aes(x=long, y=lat, group=group), fill="white", colour = "black", size=0.50)+
  theme(panel.background = element_rect(fill = "white", colour = "grey50"))+
  coord_map("bonne", lat0 = 50,
            xlim = c(-127, -112),ylim = c(41, 50))+
  xlab("Longitude") +
  ylab("Latitude")
  
```

```{r}
####setwd('/Users/Hannah 23/Documents')
#### Changing plot size and saving as a tiff file


tiff('PNW-s.tiff', units="in", 
     width=10, height=10,
     res=300, compression = 'lzw')
options(repr.plot.width=20, repr.plot.height=20)
p
dev.off()
```

## Washington counties mapping

### Load packages
```{r, message=F, echo=F}
# Packages for graphics
library(ggplot2)
library(gridExtra)
library(ggExtra)
library(naniar) # To visualize missing data
library(Hmisc) # To tabulate a summary of the data
library(maps) # for maps
library(knitr) # format tables
library(ggplot2) # For diagnostics
# Packages for data wrangling
library(dplyr)
library(tidyr)
library(reshape2)
# Packages for inference /presentation of inference*
library(stargazer)
library(plm) # For estimating fixed and random effect model
library(lmtest)
library(sandwich) # for robust standard errors
library(knitr)
opts_chunk$set(tidy.opts=list(width.cutoff=60),tidy=TRUE)
```
### Load historic potato acreage data
```{r setup, include=FALSE}
data_list #Load in acreage
#Rename dataframe
df <- data_list
```
### Summary of dataframe
```{r setup, include=FALSE}
#Checking structure 
str(df)
#Summary of dataframe
summary("df")

```
### Check for missing values
```{r}
is.na(df)
```
### Open map data
```{r message=F, warning=F, fig.cap="Potato acreage in Washington state over time", echo=FALSE}
MainStates <- map_data("state")
```
# Average acreage of WA counties over time
```{r}
# Automate county level average for each county
MuAcreageDf <- dta %>%
  group_by(county_name) %>%
  summarise('MuAcres' = mean(value, na.rm = TRUE)) %>%
  dplyr::select(MuAcres, county_name) 

#Need to manually add in Garfield county with 0 acreage (not included on original dataframe, did not have any potato acreage listed)
MuAcreageDf[nrow(MuAcreageDf) + 1,] = list(0, "garfield")


#Delete first row in MuAcreageDf that is blank in the county row and the average of all the counties in the other row and remove Other(combined)counties row
MuAcreageDf <- MuAcreageDf[-c(1,25),]

#Rename county column in MuAcreageDf to "subregion" to match the map county column name and change the MuAcreageDf counties to all lowercase to match the map dataframe so they can be joined
colnames(MuAcreageDf)[2] <- "subregion"

MuAcreageDf$subregion <- tolower(MuAcreageDf$subregion)

#Round MuAcres to a whole number
MuAcreageDf[,-2] <- round(MuAcreageDf[,-2],0)

# Coerce Value to numeric
as.numeric(as.character(dta$Value))
class(dta)

dta[county_name == "COLUMBIA",] # what does (D) mean?- Not enough farms to enable anonymity (pg.X in doc Y)
```
### WA county map
```{r}
# Base WA county map
states <- map_data("state")
dim(states)
ut_df <- subset(states, region == "washington")
head(ut_df)

counties <- map_data("county")
ut_county <- subset(counties, region == "washington")
head(ut_county)

ut_base <- ggplot(data = ut_df,
                  mapping = aes(x = long,
                                y = lat,
                                group = 
group,
fill = subregion)) +
coord_fixed(1.3) +
geom_polygon(color = "black", fill = "gray")

ut_base + theme_classic() +
geom_polygon(data = ut_county, fill = NA, color = "white") +
geom_polygon(color = "black", fill = NA)  # get the state border back on top

#Joined county data, ut_county dataframe is map data for the counties in Washington state, MuAcreageDf includes the average potato acreage for each county over time
JoinedCounties <- inner_join(ut_county, MuAcreageDf, by = "subregion")

# WA county map with joined data. Color gradient based on MuAcres column
MuAcreagePlot <- ggplot() + 
  geom_polygon(data=JoinedCounties ,
               aes(x=long, y=lat, group=group,
               fill=MuAcres),
                color="black", lwd=0.3) +
  scale_fill_gradient(low="blue", high="red") +
  theme_classic() + coord_map("conic", lat0 = 30) +
  ggtitle("WA County Historic Potato Acreage Averages 1882-2019")

#Add surrounding states and provinces to WA map
us <- getData("GADM",country="USA",level=1)
canada <- getData("GADM",country="CAN",level=1)
states <- c('Idaho', 'Oregon')
provinces <- c("British Columbia", "Alberta")
# PNW
us.states <- us[us$NAME_1 %in% states,]
# Canada
ca.provinces <- canada[canada$NAME_1 %in% provinces,]
#WA average map with surrounding states and provinces
PNWAcreage <- ggplot(us.states,
       aes(x=long, y=lat, group=group))+
  geom_path(size=0.25)+
  geom_path(data=ca.provinces, size=0.25,color="grey60")+
  geom_polygon(data=subset(us.states, NAME_1 %in% c('Idaho', 'Oregon')),
               aes(x=long, y=lat, group=group), fill="white", colour = "grey50", size=0.50)+ 
 geom_polygon(data=JoinedCounties, #Start of MuAcreagePlot
               aes(x=long, y=lat, group=group,
               fill=MuAcres),
                color="black", lwd=0.3) +
  scale_fill_gradient(low="blue", high="red") +
  theme_classic() + coord_map("conic", lat0 = 30) +
  ggtitle("WA County Historic Potato Acreage Averages 1882-2019") + 
  labs(fill = "Average Acreage")+
  labs(caption = "Counties shown in grey were not included in NASS dataset to protect farm anonymity.") +
  theme(plot.caption = element_text(hjust = 0))+ #End of MuAcreagePlot
  theme(panel.background = element_rect(fill = "white", colour = "grey50"))+
 coord_map("bonne", lat0 = 50,
            xlim = c(-127, -112),ylim = c(41, 50))+
  xlab("Longitude") +
  ylab("Latitude") 
```
```{r}
#Gathered yearly acreage data

##Create new dataframe that only includes the county, year and acreage (value), columns from the original dta dataframe
HistoricAcreage <- dta %>%
  dplyr::select(county_name, year, value) #Many instances of years with acreage values but no county listed. Sometimes the same year has more than one acreage listed. Sometimes these repeated years have the same acreage, sometimes it is different.
```

```{r}
# For loop gather for mapping multiple individual years of data
## Notes: Collect an acreage point for each county for each year available. Have all the points for a single year plotted onto the county map. Use same color gradient as average acreage plot. Gather and for loops can automate this process for each year.
## Sample of a few years, hardcoded just to see what we're working with
Data1882 <- dta%>%
  subset(year==1882) #No specific counties listed
Data2019 <- dta %>%
  subset(year==2019)#No specific counties listed
Data2017 <- dta %>% 
  subset(year==2017) #Multiple acreages listed for the same county (same county, same year, different acreages, may just be different regions within the county). Check sector_desc, domain_desc, util_practice_desc, short_desc
  ```
### Graveyard
- This code chunk does XYZ
-This code gives a county map of WA, not using ggplot plot_usmap(regions = "counties", include = c("WA"))
- Good example on how to color-code based on value ranges: 
 scale_color_manual(name = "value",
                     values = c("(-Inf,10]" = "red",
                                  "(10,100]" = "yellow",
                                  "(100, Inf]" = "black"),
                     labels = c("Acreage <= 10", "10 < Acreage <= 100", "Acreage > 100"))
```{r}
df %>%
  dplyr::select('AverageAcerage' = mean(acerage)) # package::function()
```
# Outlier plot
  
```{r}
dta %>%
  group_by(year) %>%
  select(year, value, county_name) %>%
  ggplot(aes(x=year, y=value)) +
  geom_point(aes(colour = cut(value, c(-Inf, 10, 100, Inf))),
             size = 1)+
  scale_color_manual(name = "value",
                     values = c("(-Inf,10]" = "red",
                                  "(10,100]" = "yellow",
                                  "(100, Inf]" = "black"),
                     labels = c("Acreage <= 10", "10 < Acreage <= 100", "Acreage > 100")) +
  theme_classic() +
  theme(axis.title.x=element_text(size=16, face="bold"),
        axis.text.x=element_text(size=14),
        axis.title.y=element_text(size=16,face="bold"),
        axis.text.y=element_text(size=14)) +
  labs(x="Time (1882-2019)",
       y="Acres") +
  ggtitle("WA County Historic Potato Acreages") +
  theme(plot.title = element_text(hjust = 0.5)) +
  geom_smooth(method = "loess", span = 0.1, se = FALSE, color="grey40")+
  theme(legend.position = "right")  

### Average acreage per county, counties with single digit acreages have notes
# Adams
AdamsData <- subset(dta, county_name == 'ADAMS') 
AdamsAverageAcreage <- mean(AdamsData$value, na.rm = TRUE)

# Asotin
AsotinData <- subset(dta, county_name == 'ASOTIN')
AsotinAverageAcreage <- mean(AsotinData$value, na.rm = TRUE)
### Asotin only has 1 acre listed for 2 years of recorded data?

# Benton
BentonData <- subset(dta, county_name == 'BENTON')
BentonAverageAcreage <- mean(BentonData$value, na.rm = TRUE)

# Chelan
ChelanData <- subset(dta, county_name == 'CHELAN')
ChelanAverageAcreage <- mean(ChelanData$value, na.rm = TRUE)
### Weird values too, only 1 or 2 acres listed

# Clallam
ClallamData <- subset(dta, county_name == 'CLALLAM')
ClallamAverageAcreage <- mean(ClallamData$value, na.rm = TRUE)
### Weird low acreages 

# Clark
ClarkData <- subset(dta, county_name == 'CLARK')
ClarkAverageAcreage <- mean(ClarkData$value, na.rm = TRUE)

# Columbia
ColumbiaData <- subset(dta, county_name == 'COLUMBIA')
ColumbiaAverageAcreage <- mean(ColumbiaData$value, na.rm = TRUE)
### All values N/A or listed as "D"

# Cowlitz
CowlitzData<- subset(dta, county_name == 'COWLITZ')
CowlitzAverageAcreage <- mean(CowlitzData$value, na.rm = TRUE)

# Douglas
DouglasData <- subset(dta, county_name == 'DOUGLAS')
DouglasAverageAcreage <- mean(DouglasData$value, na.rm = TRUE)

# Ferry
FerryData <- subset(dta, county_name == 'FERRY')
FerryAverageAcreage <- mean(FerryData$value, na.rm = TRUE)
### Only 1 acre listed

# Franklin
FranklinData <- subset(dta, county_name == 'FRANKLIN')
FranklinAverageAcreage <- mean(FranklinData$value, na.rm = TRUE)

# Garfield, none
GarfieldAverageAcreage <- 0

# Grant
GrantData <- subset(dta, county_name == 'GRANT')
GrantAverageAcreage <- mean(GrantData$value, na.rm = TRUE)

# Grays Harbor
GraysHarborData <- subset(dta, county_name == 'GRAYS HARBOR')
GraysHarborAverageAcreage <- mean(GraysHarborData$value, na.rm = TRUE)

# Island
IslandData <- subset(dta, county_name == 'ISLAND')
IslandAverageAcreage <- mean(IslandData$value, na.rm = TRUE)

# Jefferson
JeffersonData <- subset(dta, county_name == 'JEFFERSON')
JeffersonAverageAcreage <- mean(JeffersonData$value, na.rm = TRUE)
### Low acreage

# King
KingData <- subset(dta, county_name == 'KING')
KingAverageAcreage <- mean(KingData$value, na.rm = TRUE)

# Kitsap
KitsapData <- subset(dta, county_name == 'KITSAP')
KitsapAverageAcreage <- mean(KitsapData$value, na.rm = TRUE)
### Low acreage

# Kittitas
KittitasData <- subset(dta, county_name == 'KITTITAS')
KittitasAverageAcreage <- mean(KittitasData$value, na.rm = TRUE)

# Klickitat
KlickitatData <- subset(dta, county_name == 'KLICKITAT')
KlickitatAverageAcreage <- mean(KlickitatData$value, na.rm = TRUE)

# Lewis
LewisData <- subset(dta, county_name == 'LEWIS')
LewisAverageAcreage <- mean(LewisData$value, na.rm = TRUE)
### Low acreage

# Lincoln
LincolnData <- subset(dta, county_name == 'LINCOLN')
LincolnAverageAcreage <- mean(LincolnData$value, na.rm = TRUE)

# Mason
MasonData <- subset(dta, county_name == 'MASON')
MasonAverageAcreage <- mean(MasonData$value, na.rm = TRUE)
### Low acreage

# Okanogan
OkanoganData <- subset(dta, county_name == 'OKANOGAN')
OkanoganAverageAcreage <- mean(OkanoganData$value, na.rm = TRUE)

# Pacific
PacificData <- subset(dta, county_name == 'PACIFIC')
PacificAverageAcreage <- mean(PacificData$value, na.rm = TRUE)
### Low acreage

# Pend Oreille
PendOreilleData <- subset(dta, county_name == 'PEND OREILLE')
PendOreilleAverageAcreage <- mean(PendOreilleData$value, na.rm = TRUE)
### Low acreage

# Pierce
PierceData <- subset(dta, county_name == 'PIERCE')
PierceAverageAcreage <- mean(PierceData$value, na.rm = TRUE)

# San Juan
SanJuanData <- subset(dta, county_name == 'SAN JUAN')
SanJuanAverageAcreage <- mean(SanJuanData$value, na.rm = TRUE)
### Low acreage

# Skagit
SkagitData <- subset(dta, county_name == 'SKAGIT')
SkagitAverageAcreage <- mean(SkagitData$value, na.rm = TRUE)

# Skamania
SkamaniaData <- subset(dta, county_name == 'SKAMANIA')
SkamaniaAverageAcreage <- mean(SkamaniaData$value, na.rm = TRUE)
### Low acreage

# Snohomish
SnohomishData<- subset(dta, county_name == 'SNOHOMISH')
SnohomishAverageAcreage <- mean(SnohomishData$value, na.rm = TRUE)

# Spokane
SpokaneData <- subset(dta, county_name == 'SPOKANE')
SpokaneAverageAcreage <- mean(SpokaneData$value, na.rm = TRUE)

# Stevens
StevensData <- subset(dta, county_name == 'STEVENS')
StevensAverageAcreage <- mean(StevensData$value, na.rm = TRUE)

# Thurston
ThurstonData <- subset(dta, county_name == 'THURSTON')
ThurstonAverageAcreage <- mean(ThurstonData$value, na.rm = TRUE)
### Low acreage

# Wahkiakum
WahkiakumData <- subset(dta, county_name == 'WAHKIAKUM')
WahkiakumAverageAcreage <- mean(WahkiakumData$value, na.rm = TRUE)
### Low acreage

# Walla Walla
WallaWallaData <- subset(dta, county_name == 'WALLA WALLA')
WallaWallaAverageAcreage <- mean(WallaWallaData$value, na.rm = TRUE)

# Whatcom
WhatcomData <- subset(dta, county_name == 'WHATCOM')
WhatcomAverageAcreage <- mean(WhatcomData$value, na.rm = TRUE)

# Whitman
WhitmanData <- subset(dta, county_name == 'WHITMAN')
WhitmanAverageAcreage <- mean(WhitmanData$value, na.rm = TRUE)

# Yakima
YakimaData<- subset(dta, county_name == 'YAKIMA')
YakimaAverageAcreage <- mean(YakimaData$value, na.rm = TRUE)

# Other/unlisted
OtherUnlistedData <- subset(dta, county_name == '')
OtherUnlistedAverageAcreage <- mean(OtherUnlistedData$value, na.rm = TRUE)

### Dataframe of means
WACountyMeans <- data.frame(AdamsAverageAcreage, AsotinAverageAcreage, BentonAverageAcreage, ChelanAverageAcreage, ClallamAverageAcreage, ClarkAverageAcreage, ColumbiaAverageAcreage, CowlitzAverageAcreage, DouglasAverageAcreage, FerryAverageAcreage, FranklinAverageAcreage, GrantAverageAcreage, GraysHarborAverageAcreage, IslandAverageAcreage, JeffersonAverageAcreage, KingAverageAcreage, KitsapAverageAcreage, KittitasAverageAcreage, KlickitatAverageAcreage, LewisAverageAcreage, LincolnAverageAcreage, MasonAverageAcreage, OkanoganAverageAcreage, PacificAverageAcreage, PendOreilleAverageAcreage, PierceAverageAcreage, SanJuanAverageAcreage, SkagitAverageAcreage, SkamaniaAverageAcreage, SnohomishAverageAcreage, SpokaneAverageAcreage, StevensAverageAcreage, ThurstonAverageAcreage, WahkiakumAverageAcreage, WallaWallaAverageAcreage, WhatcomAverageAcreage, WhitmanAverageAcreage, YakimaAverageAcreage, OtherUnlistedAverageAcreage)
```
